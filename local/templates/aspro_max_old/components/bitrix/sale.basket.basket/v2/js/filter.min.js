!function(){"use strict";BX.namespace("BX.Sale.BasketFilter"),BX.Sale.BasketFilter=function(component){this.component=component,this.activeFilterMode=!1,this.filterTimer=null,this.mouseOverClearFilter=!1,this.realShownItems=[],this.realSortedItems=[],this.realScrollTop=0,this.lastShownItemsHash="",this.currentFilter={query:"",similarHash:"",warning:!1,notAvailable:!1,delayed:!1},this.component.useItemsFilter&&this.bindEvents()},BX.Sale.BasketFilter.prototype.bindEvents=function(){var entity,filterNode=this.component.getEntity(this.component.getCacheNode(this.component.ids.itemListWrapper),"basket-filter");entity=this.component.getEntity(filterNode,"basket-filter-input"),BX.type.isDomNode(entity)&&(BX.bind(entity,"focus",(function(){filterNode.style.flex=3})),BX.bind(entity,"blur",BX.delegate((function(){this.mouseOverClearFilter||(filterNode.style.flex="")}),this)),BX.bind(entity,"keyup",BX.proxy(this.onFilterInput,this)),BX.bind(entity,"cut",BX.proxy(this.onFilterInput,this)),BX.bind(entity,"paste",BX.proxy(this.onFilterInput,this))),entity=this.component.getEntity(filterNode,"basket-filter-clear-btn"),BX.type.isDomNode(entity)&&(BX.bind(entity,"mouseenter",BX.delegate((function(){this.mouseOverClearFilter=!0}),this)),BX.bind(entity,"mouseout",BX.delegate((function(){this.mouseOverClearFilter=!1}),this)),BX.bind(entity,"click",BX.delegate((function(){this.filterInputEmpty()||(this.clearFilterInput(),this.onFilterChange()),filterNode.style.flex=""}),this)))},BX.Sale.BasketFilter.prototype.isActive=function(){return this.activeFilterMode},BX.Sale.BasketFilter.prototype.showFilterByName=function(name){if(name)switch(name){case"not-available":this.showNotAvailableItemsFilter();break;case"delayed":this.showDelayItemsFilter();break;case"warning":this.showWarningItemsFilter();break;case"similar":this.showSimilarItemsFilter();break;case"all":default:this.clearAllFiltersExcept([]),this.onFilterChange()}},BX.Sale.BasketFilter.prototype.onFilterInput=function(){var value=BX.type.isDomNode(BX.proxy_context)?BX.util.trim(BX.proxy_context.value).toLowerCase():"";this.currentFilter.query!==value&&(this.currentFilter.query=value,this.onFilterChange())},BX.Sale.BasketFilter.prototype.clearAllFiltersExcept=function(names){names&&BX.type.isArray(names)&&(!BX.util.in_array("input",names)&&this.clearFilterInput(),!BX.util.in_array("warning",names)&&this.clearWarningItemsFilter(),!BX.util.in_array("delayed",names)&&this.clearDelayItemsFilter(),!BX.util.in_array("not-available",names)&&this.clearNotAvailableItemsFilter(),BX.util.in_array("similar",names)||(this.clearSimilarItemsFilter(),this.component.showSimilarCount(!1)))},BX.Sale.BasketFilter.prototype.filterInputEmpty=function(){return 0===this.currentFilter.query.length},BX.Sale.BasketFilter.prototype.clearFilterInput=function(){this.currentFilter.query="";var input=this.component.getEntity(this.component.getCacheNode(this.component.ids.itemListWrapper),"basket-filter-input");BX.type.isDomNode(input)&&(input.value="")},BX.Sale.BasketFilter.prototype.addWarningItemsFilter=function(){this.currentFilter.warning=!0},BX.Sale.BasketFilter.prototype.clearWarningItemsFilter=function(){this.currentFilter.warning=!1},BX.Sale.BasketFilter.prototype.showWarningItemsFilter=function(){this.currentFilter.warning||(this.clearAllFiltersExcept(["warning"]),this.addWarningItemsFilter(),this.onFilterChange())},BX.Sale.BasketFilter.prototype.addDelayItemsFilter=function(){this.currentFilter.delayed=!0},BX.Sale.BasketFilter.prototype.clearDelayItemsFilter=function(){this.currentFilter.delayed=!1},BX.Sale.BasketFilter.prototype.showDelayItemsFilter=function(){this.currentFilter.delayed||(this.clearAllFiltersExcept(["delayed"]),this.addDelayItemsFilter(),this.onFilterChange())},BX.Sale.BasketFilter.prototype.addNotAvailableItemsFilter=function(){this.currentFilter.notAvailable=!0},BX.Sale.BasketFilter.prototype.clearNotAvailableItemsFilter=function(){this.currentFilter.notAvailable=!1},BX.Sale.BasketFilter.prototype.showNotAvailableItemsFilter=function(){this.currentFilter.notAvailable||(this.clearAllFiltersExcept(["not-available"]),this.addNotAvailableItemsFilter(),this.onFilterChange())},BX.Sale.BasketFilter.prototype.addSimilarItemsFilter=function(item){this.currentFilter.similarHash=item.HASH},BX.Sale.BasketFilter.prototype.clearSimilarItemsFilter=function(){this.currentFilter.similarHash=""},BX.Sale.BasketFilter.prototype.showSimilarItemsFilter=function(){var item=this.component.getItemDataByTarget(BX.proxy_context);this.currentFilter.similarHash!==item.HASH&&(this.clearAllFiltersExcept(["similar"]),this.addSimilarItemsFilter(item),this.onFilterChange())},BX.Sale.BasketFilter.prototype.getTimeoutDuration=function(){return this.component.duration.filterTimer},BX.Sale.BasketFilter.prototype.onFilterChange=function(){this.component.showItemsOverlay(),this.currentFilter.query.length||this.currentFilter.similarHash.length||this.currentFilter.warning||this.currentFilter.notAvailable||this.currentFilter.delayed?(clearTimeout(this.filterTimer),this.filterTimer=setTimeout(BX.proxy(this.enableFilterMode,this),this.getTimeoutDuration())):this.disableFilterMode()},BX.Sale.BasketFilter.prototype.enableFilterMode=function(){var foundItemsHash;this.activeFilterMode||(this.activeFilterMode=!0,this.realShownItems=BX.util.array_values(this.component.shownItems),this.realSortedItems=BX.util.array_values(this.component.sortedItemsToFilter),this.realScrollTop=this.component.getDocumentScrollTop()),this.component.scrollToFirstItem(),this.component.sortedItems=this.searchItems(),foundItemsHash=JSON.stringify(this.component.sortedItems),this.lastShownItemsHash!==foundItemsHash?(this.lastShownItemsHash=foundItemsHash,this.component.deleteBasketItems(BX.util.array_values(this.component.shownItems),!1),this.component.sortedItems.length?(this.component.initializeBasketItems(),this.hideEmptyFilterResult()):this.showEmptyFilterResult(),this.currentFilter.similarHash.length&&this.component.showSimilarCount(!0)):this.highlightFoundItems(),this.component.hideItemsOverlay()},BX.Sale.BasketFilter.prototype.disableFilterMode=function(){clearTimeout(this.filterTimer),this.lastShownItemsHash="",this.activeFilterMode&&(this.activeFilterMode=!1,this.component.sortedItems=BX.util.array_values(this.realSortedItems),this.component.deleteBasketItems(BX.util.array_values(this.component.shownItems),!1),this.hideEmptyFilterResult(),this.component.checkCanBuyItems(),this.component.editBasketItems(BX.util.array_values(this.component.sortedItems)),window.scrollTo(0,this.realScrollTop)),this.component.hideItemsOverlay()},BX.Sale.BasketFilter.prototype.searchItems=function(){for(var items=[],i=0;i<this.realSortedItems.length;i++){var item=this.component.items[this.realSortedItems[i]];item&&this.searchItemMatch(item)&&items.push(item.ID)}return items},BX.Sale.BasketFilter.prototype.highlightFoundItems=function(){if(this.activeFilterMode)for(var i in this.component.shownItems)this.component.shownItems.hasOwnProperty(i)&&this.highlightSearchMatch(this.component.items[this.component.shownItems[i]])},BX.Sale.BasketFilter.prototype.searchItemMatch=function(item){var match=!1,found=!1;if(this.currentFilter.notAvailable){if(!(found=!!item.NOT_AVAILABLE))return match}else if(this.currentFilter.delayed){if(!(found=!!item.DELAYED))return match}else if(this.currentFilter.warning){if(!(found=BX.util.in_array(item.ID,this.component.warningItems)))return match}else if(BX.type.isNotEmptyString(this.currentFilter.similarHash)&&!(found=this.currentFilter.similarHash===item.HASH))return match;if(BX.type.isNotEmptyString(this.currentFilter.query)){if(-1!==item.NAME.toLowerCase().indexOf(this.currentFilter.query)&&(match="NAME"),!match){var floatValue=parseFloat(this.currentFilter.query);isNaN(floatValue)||(parseFloat(item.PRICE)===floatValue?match="PRICE":parseFloat(item.SUM_PRICE)===floatValue&&(match="SUM_PRICE"))}var k,lcValue;if(!match&&this.currentFilter.query.length>=3&&(-1!==item.PRICE_FORMATED.toLowerCase().indexOf(this.currentFilter.query)?match="PRICE":-1!==item.SUM_PRICE_FORMATED.toLowerCase().indexOf(this.currentFilter.query)&&(match="SUM_PRICE")),!match&&item.PROPS.length)for(k in item.PROPS)if(item.PROPS.hasOwnProperty(k)&&BX.type.isNotEmptyString(item.PROPS[k].VALUE)&&((lcValue=item.PROPS[k].VALUE.toLowerCase())===this.currentFilter.query||this.currentFilter.query.length>=3&&-1!==lcValue.indexOf(this.currentFilter.query))){match="PROPS";break}if(!match&&item.COLUMN_LIST.length)for(k in item.COLUMN_LIST)if(item.COLUMN_LIST.hasOwnProperty(k)&&BX.type.isNotEmptyString(item.COLUMN_LIST[k].VALUE)&&((lcValue=item.COLUMN_LIST[k].VALUE.toLowerCase())===this.currentFilter.query||this.currentFilter.query.length>=3&&-1!==lcValue.indexOf(this.currentFilter.query))){match="COLUMNS";break}}else found&&(match=!0);return match},BX.Sale.BasketFilter.prototype.highlightSearchMatch=function(itemData){var searchMatch=this.searchItemMatch(itemData),entity,i,k,code;if(searchMatch)switch(searchMatch){case"NAME":entity=this.component.getEntity(BX(this.component.ids.item+itemData.ID),"basket-item-name"),BX.type.isDomNode(entity)&&(entity.innerHTML=itemData.NAME.replace(new RegExp("(.*)("+this.currentFilter.query.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")(.*)","gi"),(function(full,match1,match2,match3){return BX.util.htmlspecialchars(match1)+'<span class="basket-item-highlighted">'+BX.util.htmlspecialchars(match2)+"</span>"+BX.util.htmlspecialchars(match3)})));break;case"PRICE":entity=BX(this.component.ids.price+itemData.ID),BX.addClass(entity,"basket-item-highlighted");break;case"SUM_PRICE":entity=BX(this.component.ids.sumPrice+itemData.ID),BX.addClass(entity,"basket-item-highlighted");break;case"PROPS":for(entity=this.component.getEntities(BX(this.component.ids.item+itemData.ID),"basket-item-property-value"),i=0;i<entity.length;i++)for(k in code=entity[i].getAttribute("data-property-code"),itemData.PROPS)itemData.PROPS.hasOwnProperty(k)&&itemData.PROPS[k].CODE===code&&(entity[i].innerHTML=itemData.PROPS[k].VALUE.replace(new RegExp("("+this.currentFilter.query+")","gi"),'<span class="basket-item-highlighted">$1</span>'));break;case"COLUMNS":for(entity=this.component.getEntities(BX(this.component.ids.item+itemData.ID),"basket-item-property-column-value"),i=0;i<entity.length;i++)for(k in code=entity[i].getAttribute("data-column-property-code"),itemData.COLUMN_LIST)itemData.COLUMN_LIST.hasOwnProperty(k)&&itemData.COLUMN_LIST[k].CODE===code&&(entity[i].innerHTML=itemData.COLUMN_LIST[k].VALUE.replace(new RegExp("("+this.currentFilter.query+")","gi"),'<span class="basket-item-highlighted">$1</span>'))}},BX.Sale.BasketFilter.prototype.showEmptyFilterResult=function(){var itemListNode=this.component.getCacheNode(this.component.ids.itemList);if(BX.type.isDomNode(itemListNode)&&itemListNode.clientHeight>=500){var emptyResultNode=this.component.getCacheNode(this.component.ids.itemListEmptyResult);BX.type.isDomNode(emptyResultNode)&&(emptyResultNode.style.display="")}},BX.Sale.BasketFilter.prototype.hideEmptyFilterResult=function(){var emptyResultNode=this.component.getCacheNode(this.component.ids.itemListEmptyResult);BX.type.isDomNode(emptyResultNode)&&(emptyResultNode.style.display="none")}}();
//# sourceMappingURL=filter.min.js.map