!function(f){BX.namespace("BX.Forum");function s(e){if(this.id="FTRList"+e.form.id,this.mess={},this.form=e.form,e.id)for(var t=0;t<e.id.length;t++)this.bind(e.id[t]);this.params={preorder:"Y"==e.preorder,pageNumber:e.pageNumber,pageCount:e.pageCount},BX.addCustomEvent(this.form,"onAdd",BX.delegate(this.add,this)),BX.addCustomEvent(this.form,"onRequest",BX.delegate(function(){if(void 0!==this.params.pageNumber){var e=this.form.elements.pageNumber;e||(e=BX.create("input",{props:{type:"hidden",name:"pageNumber"}}),this.form.appendChild(e)),e.value=this.params.pageNumber}if(void 0!==this.params.pageCount){var t=BX.findChild(this.form,{attr:{name:"pageCount"}});t||(t=BX.create("input",{props:{type:"hidden",name:"pageCount"}}),this.form.appendChild(t)),t.value=this.params.pageCount}},this)),BX.addCustomEvent(this.form,"onResponse",BX.delegate(function(){var e=BX.findChild(this.form,{attr:{name:"pageNumber"}},!0);e&&BX.remove(e)},this))}var i=(e.prototype={submit:function(e){if(this.validate()){if(this.prepareForm(),this.disableButtons(!0),!this.isAjax)return!0;this.send()}return BX.PreventDefault(e)},prepareForm:function(){},disableButtons:function(e){for(var t=this.form.getElementsByTagName("input"),i=0;i<t.length;i++)"submit"==t[i].getAttribute("type")&&(t[i].disabled=!1!==e)},validate:function(){this.editor.SaveContent();var e="",t=this.editor.GetContent().length;return this.form.TITLE&&this.form.TITLE.value.length<=0&&(e+=BX.message("no_topic_name")),t<=0?e+=BX.message("no_message"):64e3<t&&(e+=BX.message("max_len").replace(/#MAX_LENGTH#/gi,64e3).replace(/#LENGTH#/gi,t)),""===e||(alert(e),!1)},busy:!(s.prototype={add:function(e,t){var i,s=BX(this.form.id+"container"),r={className:/reviews-reply-form|reviews-collapse/},a=BX.findChild(document,{className:"reviews-reply-form"},!0),o=f.fTextToNode(t.message);if(s||(s=BX.create("div",{attrs:{id:this.form.id+"container"},props:{className:"reviews-block-container reviews-reviews-block-container"},children:[BX.create("div",{props:{className:"reviews-block-outer"},children:[BX.create("div",{props:{className:"reviews-block-inner"}})]})]}),a.parentNode.insertBefore(s,a.nextSibling),s=BX(this.form.id+"container")),i=s?BX.findChild(s,{className:"reviews-block-inner"},!0):null,o&&i){if(t.allMessages){if(f.fReplaceOrInsertNode(o,i,BX.findChild(document,r,!0).parentNode,r),t.navigation&&t.pageNumber){var n,d=f.fTextToNode(t.navigation),l=d?BX.findChildren(s.parentNode,{className:"reviews-navigation-box"},!0):null;if(d){if(!l){s.parentNode.insertBefore(BX.create("div",{props:{className:"reviews-navigation-box reviews-navigation-top"}}),s);for(var h=s;(h=h.nextSibling)&&1!=h.nodeType;);var c=BX.create("div",{props:{className:"reviews-navigation-box reviews-navigation-bottom"}});h?s.parentNode.insertBefore(c,h):s.parentNode.appendChild(c),l=BX.findChildren(s.parentNode,{className:"reviews-navigation-box"},!0)}for(n=0;n<l.length;n++)l[n].innerHTML=d.innerHTML}this.params.pageNumber=t.pageNumber,this.params.pageCount=t.pageCount}if(t.messagesID&&"object"==typeof t.messagesID)for(var m=0;m<t.messagesID.length;m++)t.messagesID[m]!=e&&this.bind(t.messagesID[m])}else void 0!==t.message&&(this.params.preorder?i.appendChild(o):i.insertBefore(o,i.firstChild));f.fRunScripts(t.message),this.bind(e)}},bind:function(t){var e=BX("message"+t);if(e){this.mess["m"+t]={node:e,author:{id:e.getAttribute("bx-author-id"),name:e.getAttribute("bx-author-name")}};var i=BX.findChildren(e,{tagName:"A",className:"reviews-button-small"},!0),s=BX.delegate(function(){var e=BX.proxy_context;this.act(e.getAttribute("bx-act"),t)},this),r=BX.delegate(function(){this.act("reply",t)},this),a=BX.delegate(function(){this.act("quote",t)},this);if(i&&0<i.length)for(var o=0;o<i.length;o++)"moderate"==i[o].getAttribute("bx-act")||"del"==i[o].getAttribute("bx-act")?BX.adjust(i[o],{events:{click:s},attrs:{"bx-href":i[o].getAttribute("href"),href:"javascript:void(0);"}}):this.form&&("reply"==i[o].getAttribute("bx-act")?BX.bind(i[o],"click",r):"quote"==i[o].getAttribute("bx-act")&&BX.bind(i[o],"mousedown",a))}},act:function(a,e){if(e&&this.mess["m"+e])if("quote"==a){var t=f.GetSelection();if(document.getSelection&&(t=(t=t.replace(/\r\n\r\n/gi,"_newstringhere_").replace(/\r\n/gi," ")).replace(/  /gi,"").replace(/_newstringhere_/gi,"\r\n\r\n")),""===t&&0<e&&BX("message_text_"+e,!0)){var i=BX("message_text_"+e,!0);"object"==typeof i&&i&&(t=i.innerHTML)}t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/[\n|\r]*<br(\s)*(\/)*>/gi,"\n")).replace(/<script[^>]*>/gi,"").replace(/<\/script[^>]*>/gi,"")).replace(/\001([^\002]*)\002/gi,function(e,t){var i=" ",s=/showWMVPlayer.*?bx_wmv_player.*?file:[\s'"]*([^"']*).*?width:[\s'"]*([^"']*).*?height:[\s'"]*([^'"]*).*?/gi.exec(t);if(s&&(i="[VIDEO WIDTH="+s[2]+" HEIGHT="+s[3]+"]"+s[1]+"[/VIDEO]")," "==i){(s=/bxPlayerOnload[\s\S]*?[\s'"]*file[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*height[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*width[\s'"]*:[\s'"]*([^"']*)/gi.exec(t))&&(i="[VIDEO WIDTH="+s[3]+" HEIGHT="+s[2]+"]"+s[1]+"[/VIDEO]")}return i})).replace(/<noscript[^>]*>/gi,"").replace(/<\/noscript[^>]*>/gi,"")).replace(/\003([^\004]*)\004/gi," ")).replace(/<table class\=[\"]*forum-quote[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,"")).replace(/<table class\=[\"]*forum-code[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,"")).replace(/<table class\=[\"]*data-table[\"]*>[^<]*<tbody>/gi,"")).replace(/<\/td>[^<]*<\/tr>(<\/tbody>)*<\/table>/gi,"")).replace(/[\r|\n]{2,}([\001|\002])/gi,"\n$1");for(var s=0;s++<50&&(0<=t.search(/\002([^\002\003]*)\003/gi)||0<=t.search(/\001([^\001\003]*)\003/gi));)t=t.replace(/\002([^\002\003]*)\003/gi,"[CODE]$1[/CODE]").replace(/\001([^\001\003]*)\003/gi,"[QUOTE]$1[/QUOTE]");function r(e,t,i){for(var s=new RegExp("([^]*)("+t+")([^]*)","i"),r=new RegExp("((?:)(?:[^]*))("+t+")((?:[^]*)(?:))","i"),a=0;a++<300&&0<=e.search(s);)e=e.replace(r,"$1"+i+"$3");return e}for(s=0;s++<10&&0<=t.search(/\004([^\004\003]*)\003/gi);)t=(t=r(t=r(t=r(t=r(t,"<tr>","[TR]"),"</tr>","[/TR]"),"<td>","[TD]"),"</td>","[/TD]")).replace(/\004([^\004\003]*)\003/gi,"[TABLE]$1[/TD][/TR][/TABLE]");t=(t=(t=(t=(t=(t=(t=BX.browser.IsIE()?t.replace(/<img(?:(?:\s+alt\s*=\s*\"?smile([^\"\s]+)\"?)|(?:\s+\w+\s*=\s*[^\s>]*))*>/gi,"$1"):t.replace(/<img.*?alt=[\"]*smile([^\"\s]+)[\"]*[^>]*>/gi,"$1")).replace(/<a[^>]+href=[\"]([^\"]+)\"[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]")).replace(/<a[^>]+href=[\']([^\']+)\'[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]")).replace(/<[^>]+>/gi," ").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&quot;/gi,'"')).replace(/(smile(?=[:;8]))/g,"")).replace(/\&shy;/gi,"")).replace(/\&nbsp;/gi," "),BX.onCustomEvent(this.form,"onQuote",[{author:this.mess["m"+e].author,id:e,text:t}])}else if("reply"==a)BX.onCustomEvent(this.form,"onReply",[{author:this.mess["m"+e].author,id:e}]);else if("del"!=a||confirm(BX.message("f_cdm"))){if("moderate"==a||"del"==a){function o(){BX.remove(h),BX.show(n.parentNode)}var n=BX.proxy_context,d=n.getAttribute("bx-href").replace(/.AJAX_CALL=Y/g,"").replace(/.sessid=[^&]*/g,""),l=BX.findParent(n,{tag:"table"}),h=BX.create("a",{attrs:{className:"reply-action-note"}});BX.hide(n.parentNode),h.innerHTML=BX.message("f_wait"),n.parentNode.parentNode.appendChild(h),BX.ajax.loadJSON(d,{AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},BX.delegate(function(e){if(e.status&&l)if(BX.onCustomEvent(f,"onForumCommentAJAXAction",[a]),"del"==a){var t=f.curpage||top.window.location.href;BX.fx.hide(l,"scroll",{time:.15,callback_complete:BX.delegate(function(){BX.remove(l),o();var e=BX.findChild(BX(this.form.id+"container"),{class:"reviews-post-table"},!0,!0);(!e||e.length<1)&&1<this.params.pageNumber&&BX.reload(t)},this)})}else{var i=BX.hasClass(l,"reviews-post-hidden"),s=i?BX.message("f_hide"):BX.message("f_show"),r=BX.findChild(l,{className:"reviews-text"},!0);BX.fx.hide(r,"fade",{time:.1,callback_complete:function(){BX.toggleClass(l,"reviews-post-hidden"),n.innerHTML=s,d=d.replace(new RegExp("REVIEW_ACTION="+(i?"SHOW":"HIDE")),"REVIEW_ACTION="+(i?"HIDE":"SHOW")),n.setAttribute("bx-href",d),BX.fx.show(r,"fade",{time:.1}),o(),BX.style(r,"background-color",i?"#FFFFFF":"#E5F8E3")}})}else BX.addClass(h,"error"),h.innerHTML='<span class="errortext">'+e.message+"</span>"},this))}}else BX.DoNothing();else BX.DoNothing();return!1}}),send:function(){return!0!==this.busy&&(this.busy=!0,this.form.elements.dataType||this.form.appendChild(BX.create("input",{props:{type:"hidden",name:"dataType",value:"json"}})),BX.onCustomEvent(this.form,"onRequest",[this.form,this]),BX.ajax.submitAjax(this.form,{method:"POST",url:this.form.action,dataType:"json",onsuccess:this.onsuccess,onfailure:this.onfailure}),!0)},onsuccess:function(e){this.busy=!1,this.disableButtons(!1),BX.onCustomEvent(this.form,"onResponse",[this.form,this]),this.get(e)},onfailure:function(){BX.onCustomEvent(this.form,"onResponse",[this.form,this]),BX.reload()},get:function(e){if(f.curpage=f.curpage||top.window.location.href,BX.onCustomEvent(f,"onForumCommentAJAXPost",[e,this.form]),void 0===e||e.reload)BX.reload(f.curpage);else{if(e.status){if(e.allMessages||void 0!==e.message)BX.onCustomEvent(this.form,"onAdd",[e.messageID,e]),this.clear();else if(e.previewMessage){var t=BX.findChild(document,{className:"reviews-preview"},!0),i=BX.findChild(document,{className:/reviews-reply-form|reviews-collapse/},!0).parentNode,s=f.fTextToNode(e.previewMessage);f.fReplaceOrInsertNode(s,t,i,{className:/reviews-reply-form|reviews-collapse/}),f.PostFormAjaxStatus(""),f.fRunScripts(e.previewMessage)}var r=e.messageID?BX("message"+e.messageID):null;r&&BX.scrollToNode(r)}f.PostFormAjaxStatus(e.statusMessage)}},clear:function(){this.editor.CheckAndReInit(""),this.editor.fAutosave&&BX.bind(this.editor.pEditorDocument,"keydown",BX.proxy(this.editor.fAutosave.Init,this.editor.fAutosave));var e=BX.findChild(document,{className:"reviews-preview"},!0);e&&BX.remove(e);for(var t,i,s,r=0;(t=BX("upload_files_"+r+++"_"+this.form.index.value))&&t;)(i=BX.findChild(t,{tagName:"input"},!0))&&BX(i)&&((s=BX.clone(i)).value="",i.parentNode.insertBefore(s,i),i.parentNode.removeChild(i)),BX.hide(t);var a=BX.findChild(this.form,{className:"forum-upload-file-attach"},!0);a&&BX.show(a);var o=BX.findChild(this.form,{className:"reviews-upload-info"},!0);o&&BX.hide(o);var n=null,d=BX.findChild(this.form,{attr:{name:"captcha_code"}},!0),l=BX.findChild(this.form,{attr:{name:"captcha_word"}},!0),h=BX.findChild(this.form,{className:"reviews-reply-field-captcha-image"},!0);h&&(n=BX.findChild(h,{tag:"img"})),d&&l&&n&&(l.value="",BX.ajax.getCaptcha(function(e){d.value=e.captcha_sid,n.src="/bitrix/tools/captcha.php?captcha_code="+e.captcha_sid}))},show:function(){return BX.onCustomEvent(this.form,"onBeforeShow",[this]),BX.show(this.form.parentNode),BX.scrollToNode(BX.findChild(this.form,{attribute:{name:"send_button"}},!0)),setTimeout(BX.delegate(function(){this.editor.Focus(),BX.defer(this.editor.Focus,this.editor)()},this),100),BX.onCustomEvent(this.form,"onAfterShow",[this]),!1},hide:function(){return BX.onCustomEvent(this.form,"onBeforeHide",[this]),BX.hide(this.form.parentNode),BX.onCustomEvent(this.form,"onAfterHide",[this]),!1},transverse:function(){return"none"==this.form.parentNode.style.display?this.show():this.hide(),!1},quote:function(e){BX.onCustomEvent(this.form,"onPaste",[e,"QUOTE",this]);var t=e.author||null,i=e.text||"";"wysiwyg"==this.editor.GetViewMode()?(i=i.replace(/</gi,"&lt;").replace(/>/gi,"&gt;").replace(/\n/g,"<br/>"),t&&(i=(t=(t=0<t.id?'<span id="'+this.editor.SetBxTag(!1,{tag:"postuser",params:{value:t.id}})+'" class="bxhtmled-metion">'+t.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>":"<span>"+t.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>")?t+BX.message("f_author")+"<br/>":"")+i)):this.editor.bbCode&&t&&(i=(t=""!==(t=0<t.id?"[USER="+t.id+"]"+t.name+"[/USER]":t.name)?t+BX.message("f_author")+"\n":"")+i),this.editor.action.actions.quote.setExternalSelection(i),this.editor.action.Exec("quote")},paste:function(e){BX.onCustomEvent(this.form,"onPaste",[e,"REPLY",this]);var t=e.author||null;if(t)if("wysiwyg"==this.editor.GetViewMode()){var i=this.editor.GetIframeDoc(),s=this.editor.selection.GetRange(),r=BX.create("SPAN",{props:{className:"bxhtmled-metion"},text:BX.util.htmlspecialcharsback(t.name)},i),a=BX.create("SPAN",{html:",&nbsp;"},i);if(this.editor.SetBxTag(r,{tag:"postuser",params:{value:t.id}}),this.editor.selection.InsertNode(r,s),r&&r.parentNode){var o=BX.findParent(r,{className:"bxhtmled-metion"},i.body);o&&this.editor.util.InsertAfter(r,o)}r&&r.parentNode&&(this.editor.util.InsertAfter(a,r),this.editor.selection.SetAfter(a))}else"code"==this.editor.GetViewMode()&&this.editor.bbCode&&(this.editor.textareaView.Focus(),this.editor.textareaView.WrapWith(!1,!1,"[USER="+t.id+"]"+t.name+"[/USER],"))}},e),r=[];function e(e,t){if(this.id="FTRForm"+e.form.id,this.form=e.form,this.editor=t,this.windowEvents={},this.params={messageMax:64e3},this.onsuccess=BX.delegate(this.onsuccess,this),this.onfailure=BX.delegate(this.onfailure,this),this.submit=BX.delegate(this.submit,this),BX.bind(this.form,"submit",this.submit),this.isAjax="Y"==e.ajaxPost,"Y"==e.captcha){var i=new Captcha(this.form);BX.addCustomEvent(t,"OnContentChanged",BX.proxy(i.Show,i)),BX.ready(function(){BX.bind(BX("forum-refresh-captcha"),"click",BX.proxy(i.Update,i))}),"Y"==e.bVarsFromForm&&i.Show()}BX.addCustomEvent(this.form,"onQuote",BX.delegate(function(e){this.show(),this.quote(e)},this)),BX.addCustomEvent(this.form,"onReply",BX.delegate(function(e){this.show(),this.paste(e)},this)),BX.addCustomEvent(this.form,"onTransverse",BX.delegate(this.transverse,this))}BX.Forum.Init=function(t){if(t&&"object"==typeof t){var e,i;for(new s(t);(e=r.pop())&&e;)BX.removeCustomEvent(f,"OnEditorInitedAfter",e);i=function(e){a(e,t),BX.removeCustomEvent(f,"OnEditorInitedAfter",i)},r.push(i),BX.addCustomEvent(f,"OnEditorInitedAfter",i)}};var a=function(e,t){e.id==t.lheId&&(e.insertImageAfterUpload=!0,BX.bind(BX("post_message_hidden"),"focus",function(){e.Focus()}),new i(t,e))};BX.ready(function(){if(BX.browser.IsIE()){var e,t,i,s=BX.findChildren(document,{className:"reviews-post-table"},!0);if(!s)return;for(e=0;e<s.length;e++)for(i=(t=s[e].getElementsByTagName("*")).length;i--;)t[i].scrollWidth>t[i].offsetWidth&&(t[i].style.paddingBottom="20px",t[i].style.overflowY="hidden")}}),f.fTextToNode=function(e){var t=BX.create("div");return t.innerHTML=e,0<t.childNodes.length?t:null},f.PostFormAjaxStatus=function(e){var t,i=BX.findChild(document,{className:"reviews-note-box"},!0,!0);if(i)for(t=0;t<=i.length;t++)BX.remove(i[t]);if(!(e.length<1)){var s=f.fTextToNode(e);if(s){var r=BX.findChild(document,{className:"reviews-reply-form"},!0);r.parentNode.insertBefore(s,r)}}},f.SetReviewsAjaxPostTmp=function(e){f.forumAjaxPostTmp=e},f.fReplaceOrInsertNode=function(e,t,i,s){var r=null;return!!BX.type.isDomNode(i)&&(!(!BX.type.isDomNode(e)&&!BX.type.isArray(e)&&0<e.length&&!(e=f.fTextToNode(e)))&&(BX.type.isDomNode(t)&&(i=t.parentNode,r=t.nextSibling,i.removeChild(t)),(r=r||BX.findChild(i,s,!0))?r.parentNode.insertBefore(e,r):i.appendChild(e),!0))},f.fRunScripts=function(e){var t=BX.processHTML(e,!0);BX.ajax.processScripts(t.SCRIPT,!0)},f.ShowLastEditReason=function(e,t){t&&(t.style.display=e?"block":"none")},f.AttachFile=function(e,t,i,s){var r=null,a=!1;e=parseInt(e),t=parseInt(t),document.getElementById("upload_files_info_"+i).style.display="block";for(var o=e;o<e+t&&((r=document.getElementById("upload_files_"+o+"_"+i))&&null!==typeof r);o++)if("none"==r.style.display){a=!0,r.style.display="block";break}!0==(!a||e+t-1<=o)&&(s.style.display="none")},f.GetSelection=function(){var e="";return f.getSelection?e=f.getSelection().toString():document.selection&&(e=document.selection.createRange().text),e}}(window);